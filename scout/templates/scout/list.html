{% extends is_hybrid|yesno:"hybridize/base.html,scout/app.html" %}
{% load staticfiles %}

{% block title %}List{% endblock %}

{% block web_content %}

<div class="scout-filter-container">

    <div class="scout-filter-results">
        <div>Filtering by: <span id="filter_label_text">None</span></div>
        <div>Results: {{ spots|length }}</div>
    </div>

    {% if request.is_mobile or request.is_tablet %}
    <div class="scout-filter-display">
        <a id="map_link" href="/map/"><i class="fa fa-map"></i> Map</a>
    </div>
    {% endif %}

</div>

<div class="scout-list-container">

    <h2 class="scout-list-header visually-hidden">List of Food Places</h2>

    <ul class="scout-list">

        {% for spot in spots %}
            <li class="scout-list-item" id="{{ spot.spot_id }}">
                <a class="clearfix" href="detail/{{ spot.spot_id }}">

                    <div class="scout-spot-image" style="background:url('{% static "scout/img/coffee-shop-300.jpg" %}') no-repeat center center;">&nbsp;</div>

                    <div class="scout-spot-content">

                        <div style="padding:0 10px;">
                            <h3 class="scout-spot-name">{{ spot.name }} <span class="scout-spot-type">{% for type in spot.spot_types %}<span>{{ type.name }}</span>{% endfor %}</span></h3>

                            <div class="scout-spot-status">{% if spot.is_open %}<span class="open">OPEN NOW</span>{% else %}<span class="closed">CLOSED</span>{% endif %}</div>

                            <div class="scout-spot-open-period" style="display:none;">
                                <span>TODAY'S HOURS:</span>
                                {% if spot.open_periods.breakfast %}
                                    <span>Breakfast</span>
                                {% endif %}
                                {% if spot.open_periods.lunch %}
                                    <span>Lunch</span>
                                {% endif %}
                                {% if spot.open_periods.dinner %}
                                    <span>Dinner</span>
                                {% endif %}
                                {% if spot.open_periods.late_night %}
                                    <span>Late Night</span>
                                {% endif %}
                            </div>

                            <div class="scout-spot-food-served">
                            <span>SERVES:</span>
                            {% if spot.foodtype_names %}
                                {% for foodtype in spot.foodtype_names %}
                                    <span>{{ foodtype }}</span>
                                {% endfor %}
                            {% else %} <span style="color:red;">xxxxx</span> {% endif %}
                            </div>

                            <div class="scout-spot-location">
                                <div>{% if spot.building_name %}{{ spot.building_name }}{% else %} <span style="color:red;">xxxxx</span> {% endif %}</div>
                                <div style="display:none;">{% if spot.floor %}{{ spot.floor }}{% else %} <span style="color:red;">xxxxx</span> {% endif %}</div>
                                <div style="display:none;">{% if spot.room_number %}{{ spot.room_number }}{% else %} <span style="color:red;">xxxxx</span> {% endif %}</div>
                            </div>
                        </div>

                    </div>
                </a>
            </li>
        {% endfor %}

    </ul>

</div>

{% endblock %}

{% block secondary_content %}

<!-- show a map on the list page -->
<div id="list_map" style="height:100%;"></div>

<!-- since turbolinks loads the full body... generate this function in the template. then, call the function in the map.js file -->
<script type="text/javascript">

function initializeListMap() {

	var mapExists = document.getElementById("list_map");
	var myLatlng, mapOptions;

	if(mapExists) {

		// center map on uw fountain
		mapCenter = new google.maps.LatLng(47.653811, -122.307815);
        mapOptions = {
	        center: mapCenter,
	        zoom: 16,
	    };

        var styles = [
            {
                "featureType": "poi.place_of_worship",
                "elementType": "all",
                "stylers": [
                    {
                        "visibility": "off"
                    }
                ]
            },
            {
                "featureType": "poi.business",
                "elementType": "labels.icon",
                "stylers": [
                    {
                        "visibility": "off"
                    }
                ]
            }
        ]

		var map = new google.maps.Map(document.getElementById('list_map'), mapOptions);
        map.setOptions({styles: styles});

        // multiple pins on a single map
        var locations = [
            {% for spot in spots %}
            {
                "spot_name" : '{{ spot.name }}',
                "id" : '{{ spot.spot_id }}',
                "lat" : '{{ spot.latitude }}',
                "lng" : '{{ spot.longitude }}',
                "icon": 'fa-cutlery',
            },
            {% endfor %}
		]

        // create and open InfoWindow.
        var infoWindow = new google.maps.InfoWindow();
        var markers = [];

        var bounds = new google.maps.LatLngBounds();

		for (var i = 0; i < locations.length; i++) {

            var data = locations[i];

			var marker = new MarkerWithLabel({
		        position: new google.maps.LatLng(data.lat, data.lng),
		        map: map,
                //animation: google.maps.Animation.DROP,
                labelContent: "<i class='fa " + data.icon +"'></i>",
                //labelContent: "<i class='fa " + data.icon +"'></i><span class='marker-text'>" + data.spot_name + "</span>",
                labelAnchor: new google.maps.Point(6, 6),
                labelClass: "map-label", // the CSS class for the label
                icon: {
            		path: google.maps.SymbolPath.CIRCLE,
            		fillColor: '#6562aa',
            		fillOpacity: 1,
            		strokeColor: '#53518e',
                    scale: 10,
            		strokeWeight: 3
            	},
		    });

            markers.push(marker);

            // attach click event to the marker
            (function (marker, data) {

                google.maps.event.addListener(marker, "click", function (e) {

                    map.setCenter(marker.getPosition());
                    map.setZoom(18);

                    //Wrap the content inside an HTML DIV in order to set height and width of InfoWindow.
                    infoWindow.setContent("<div style = 'width:200px;'>" + data.spot_name + "</div>");
                    infoWindow.open(map, marker);
                    $('li').css('background', 'none'); // clear any highlighted spots first
                    $('#' + data.id).css('background', '#6564A8');

                    $('.scout-scroll').scrollTo('#' + data.id);

                });

                google.maps.event.addListener(infoWindow,'closeclick',function(){
                    $('#' + data.id).css('background', 'none');
                });

            })(marker, data);

            // add the marker position to boundary
            bounds.extend(marker.position);

		}

        // zoom the map automatically using the bounds of all markers
        map.fitBounds(bounds);

        // cluster the markers using marker clusterer
        var markerCluster = new MarkerClusterer(map, markers);

	}

}
</script>

{% endblock %}

{% block hybrid_content %}

<div class="list-block media-list">
    <ul>

        {% for spot in spots %}
        <li>
            <a href="detail/{{ spot.spot_id }}?hybrid=true&x_push_page=true&x_page_title={{ spot.name.split|join:"+" }}" class="item-link item-content">
                <div class="item-media">
                    <img src="{% static "scout/img/placeholder.png" %}" style="width:80px;height:80px;">
                </div>
                <div class="item-inner">
                    <div class="item-title-row">
                        <div class="item-title">{{ spot.name }}</div>
                    </div>
                    <div class="item-subtitle">{% for foodtype in spot.foodtype_names %} {{ foodtype }}, {% endfor %}</div>
                    <div class="item-text">{{ spot.building_description }}</div>
                </div>
            </a>
        </li>
        {% endfor %}

    </ul>
</div>
{% endblock %}
